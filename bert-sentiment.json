{"version":3,"kind":"Notebook","sha256":"26c738c59afdfd64f227a1171e744c8631c91ae34426390cc5ce2d50fe299538","slug":"bert-sentiment","location":"/notebook/bert_sentiment.ipynb","dependencies":[],"frontmatter":{"title":"BERTによるセンチメント分析","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"github":"https://github.com/lvzeyu/css_nlp","numbering":{"heading_1":{"enabled":true,"template":"enabled"},"heading_2":{"enabled":true,"template":"enabled"},"heading_3":{"enabled":true,"template":"enabled"},"heading_4":{"enabled":true,"template":"enabled"},"heading_5":{"enabled":true,"template":"enabled"},"heading_6":{"enabled":true,"template":"enabled"},"title":{"offset":1}},"source_url":"https://github.com/lvzeyu/css_nlp/blob/master/notebook/bert_sentiment.ipynb","edit_url":"https://github.com/lvzeyu/css_nlp/edit/master/notebook/bert_sentiment.ipynb","thumbnail":"/build/7e2db436150c38a00650f96925aa5581.svg","exports":[{"format":"ipynb","filename":"bert_sentiment.ipynb","url":"/build/bert_sentiment-10c9a072b8ac199185f5ac58c75525ed.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"link","url":"https://colab.research.google.com/github/lvzeyu/css_nlp/blob/master/notebook/bert_sentiment.ipynb","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"image","url":"/build/7e2db436150c38a00650f96925aa5581.svg","alt":"Open In Colab","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NKNSoc9oUP","urlSource":"https://colab.research.google.com/assets/colab-badge.svg"}],"urlSource":"https://colab.research.google.com/github/lvzeyu/css_nlp/blob/master/notebook/bert_sentiment.ipynb","key":"egFWiU3ubK"}],"key":"cP2OqtG6td"},{"type":"heading","depth":2,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"転移学習とファインチューニング","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"QDOeH6kSGd"}],"identifier":"id","label":"転移学習とファインチューニング","html_id":"id","implicit":true,"enumerator":"1","key":"s1Zt9EZQwc"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"転移学習は、あるタスクの学習で得られた知識を、他の関連するタスクの学習に適用する手法を指します。一般的には、以下のステップで行われることが多いです：","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"dJGm9e5zIC"}],"key":"n30Iifpk4U"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"事前学習: 事前学習モデル（pre-trained models)とは、大規模なデータセットを用いて訓練した学習済みモデルのことです。一般的に、大量のデータ（例えば、インターネット上のテキストデータ）を使用して、モデルを事前に学習します。この時点でのモデルは、言語の汎用的な特徴や構造を捉えることができます。","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"jEv7rnIgi7"}],"key":"HqlmflpF6E"}],"key":"zrFrhLCmmz"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"ファインチューニング(fine-tuning): 事前学習モデルを、特定のタスクのデータ（例えば、感情分析や質問応答）でファインチューニングします。事前学習モデルでは汎用的な特徴をあらかじめ学習しておきますので、手元にある学習データが小規模でも高精度な認識性能を達成することが知られています。","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"OisDiuwITU"}],"key":"n2x66VrCVn"}],"key":"VA9Pczz7UP"}],"key":"AANWlZwgbl"},{"type":"image","url":"/build/fine-tuning_methods-0f88d44d58067b02fe4454d82fccc880.png","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"Ejjqtm5Zx6","urlSource":"./Figure/fine-tuning_methods.png"}],"key":"xDVzOrKiYO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"センチメント分析の実装","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bGlydIhJ5b"}],"identifier":"id","label":"センチメント分析の実装","html_id":"id-1","implicit":true,"enumerator":"2","key":"L7MFvLUJED"}],"key":"DyQixvFFpi"},{"type":"block","kind":"notebook-content","children":[{"type":"admonition","kind":"custom","class":"dropdown tohokupurple","icon":"question","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Google ColabdでGPUを使用する","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"XrCujuWK7d"}],"key":"qvQTcyTuu1"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"「ランタイム」→「ランタイムのタイプを変更」→「ハードウェア アクセラレータ」→「GPU」","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"OeiHhjlNg5"}],"key":"BmzD7PhIHo"}],"key":"zG28JbctBE"}],"key":"N1w71KDkMP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"!nvidia-smi","key":"K1M6IkGNhY"},{"type":"outputs","id":"VLlDNO9s-H1mytgDOhdBX","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Sun Jan  4 16:58:32 2026       \n+-----------------------------------------------------------------------------------------+\n| NVIDIA-SMI 580.95.05              Driver Version: 580.95.05      CUDA Version: 13.0     |\n+-----------------------------------------+------------------------+----------------------+\n| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |\n|                                         |                        |               MIG M. |\n|=========================================+========================+======================|\n|   0  NVIDIA RTX A6000               Off |   00000000:01:00.0  On |                  Off |\n| 30%   35C    P8             17W /  300W |    1379MiB /  49140MiB |      0%      Default |\n|                                         |                        |                  N/A |\n+-----------------------------------------+------------------------+----------------------+\n|   1  NVIDIA RTX A6000               Off |   00000000:02:00.0 Off |                  Off |\n| 30%   26C    P8             12W /  300W |      18MiB /  49140MiB |      0%      Default |\n|                                         |                        |                  N/A |\n+-----------------------------------------+------------------------+----------------------+\n\n+-----------------------------------------------------------------------------------------+\n| Processes:                                                                              |\n|  GPU   GI   CI              PID   Type   Process name                        GPU Memory |\n|        ID   ID                                                               Usage      |\n|=========================================================================================|\n|    0   N/A  N/A            3971      G   /usr/bin/gnome-shell                    526MiB |\n|    0   N/A  N/A            4428      G   /usr/bin/Xwayland                         4MiB |\n|    0   N/A  N/A            5204      G   /usr/share/code/code                    543MiB |\n|    1   N/A  N/A            3971      G   /usr/bin/gnome-shell                      4MiB |\n+-----------------------------------------------------------------------------------------+\n"},"children":[],"key":"j2hh7ADtJq"}],"key":"p10gesgaRP"}],"key":"g9uoyBGyIc"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"データセット","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZVg5qHAsTT"}],"identifier":"id","label":"データセット","html_id":"id-2","implicit":true,"enumerator":"2.1","key":"uZKwYTyx05"}],"key":"AjF9re01x7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Hugging Faceからサンプルデータの取得","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gsWQZrHVBC"}],"identifier":"hugging-face","label":"Hugging Faceからサンプルデータの取得","html_id":"hugging-face","implicit":true,"enumerator":"2.1.1","key":"QbUzh1NTMA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Hugging Faceのには色々なデータセットが用意されております。ここでは、多言語のセンチメントデータセットを例として使用することにします。その中に、英語と日本語のサプセットが含まれます。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zvp1lVQKF0"}],"key":"Lu54HNncNC"}],"key":"PfTxPjHwz7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"!pip -q install \"datasets<4.0.0\"","key":"LlWsFg13tv"},{"type":"outputs","id":"eL7LwMIdIXhdEjz94r3vu","children":[],"key":"i8d9tfSc7w"}],"key":"bRDLKJB4M6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from datasets import load_dataset\n#dataset = load_dataset(\"tyqiangz/multilingual-sentiments\", \"japanese\")\ndataset = load_dataset(\"tyqiangz/multilingual-sentiments\", \"english\")","key":"cVoEuCfw1p"},{"type":"outputs","id":"_TxL9WEgW_FI6sXUua-LP","children":[],"key":"iXNR42Azzm"}],"key":"VuoG57f9AQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Weights & Biases (wandb)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HJrxfSRRgL"}],"identifier":"weights-biases-wandb","label":"Weights & Biases (wandb)","html_id":"weights-biases-wandb","implicit":true,"enumerator":"2.1.2","key":"MG9vF62YfF"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Weights & Biases (wandb)は、機械学習の実験を追跡・可視化・管理するためのプラットフォームです。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vNPAywpVKd"}],"key":"LCgLxmVWWz"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"主な機能：","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dusD0Xkydm"}],"key":"WOkIMonOh4"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"実験追跡","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"mrZTCHCVCX"}],"key":"YrIWqG82wy"},{"type":"text","value":": 学習の進捗、損失、精度などのメトリクスをリアルタイムで記録・可視化","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"cydX6Zzaqk"}],"key":"lDcroifCtG"}],"key":"SlVS92Rrfd"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"ハイパーパラメータ管理","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"LlVGEzhltF"}],"key":"EgftwdlVVZ"},{"type":"text","value":": 異なる設定での実験結果を比較","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bvYxCqwB9I"}],"key":"qoyFMpCF4q"}],"key":"u0UHeRbMuf"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"モデル管理","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Vcib3LnL5U"}],"key":"a9y6TsHMju"},{"type":"text","value":": 学習済みモデルのバージョン管理と共有","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Hbo1y0WREY"}],"key":"caJicwMC8m"}],"key":"rw1WRGfhEs"}],"key":"zfNc7C6gIB"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"ここでは、モデルの学習過程を追跡するためにwandbを使用します。","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"shzjpJYLDw"},{"type":"inlineCode","value":"wandb.login()","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"kRK5fufdwH"},{"type":"text","value":"でアカウントにログインし、実験結果をクラウドに保存します。","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"h1xOV0u8ou"}],"key":"RdUg3TeyD2"}],"key":"W4UHOwUUS6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"!pip install wandb\nimport wandb\nwandb.login()","key":"zDfQaYqPeC"},{"type":"outputs","id":"RlQ_oS1RXb8kGWFMtvbtf","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Requirement already satisfied: wandb in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (0.23.1)\nRequirement already satisfied: click>=8.0.1 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (8.1.7)\nRequirement already satisfied: gitpython!=3.1.29,>=1.0.0 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (3.1.37)\nRequirement already satisfied: packaging in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (24.1)\nRequirement already satisfied: platformdirs in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (3.10.0)\nRequirement already satisfied: protobuf!=4.21.0,!=5.28.0,<7,>=3.19.0 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (3.20.3)\nRequirement already satisfied: pydantic<3 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (2.10.6)\nRequirement already satisfied: pyyaml in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (6.0.1)\nRequirement already satisfied: requests<3,>=2.0.0 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (2.32.5)\nRequirement already satisfied: sentry-sdk>=2.0.0 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (2.48.0)\nRequirement already satisfied: typing-extensions<5,>=4.8 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from wandb) (4.12.2)\nRequirement already satisfied: gitdb<5,>=4.0.1 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from gitpython!=3.1.29,>=1.0.0->wandb) (4.0.7)\nRequirement already satisfied: annotated-types>=0.6.0 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from pydantic<3->wandb) (0.7.0)\nRequirement already satisfied: pydantic-core==2.27.2 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from pydantic<3->wandb) (2.27.2)\nRequirement already satisfied: charset_normalizer<4,>=2 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from requests<3,>=2.0.0->wandb) (2.0.4)\nRequirement already satisfied: idna<4,>=2.5 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from requests<3,>=2.0.0->wandb) (3.4)\nRequirement already satisfied: urllib3<3,>=1.21.1 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from requests<3,>=2.0.0->wandb) (2.0.7)\nRequirement already satisfied: certifi>=2017.4.17 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from requests<3,>=2.0.0->wandb) (2024.2.2)\nRequirement already satisfied: smmap<5,>=3.0.1 in /home/lvzeyu/anaconda3/lib/python3.11/site-packages (from gitdb<5,>=4.0.1->gitpython!=3.1.29,>=1.0.0->wandb) (4.0.0)\n"},"children":[],"key":"hJszDr01jO"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"\u001b[34m\u001b[1mwandb\u001b[0m: Currently logged in as: \u001b[33mlvzeyu1995\u001b[0m (\u001b[33mlvzeyu1995-tohoku-university\u001b[0m) to \u001b[32mhttps://api.wandb.ai\u001b[0m. Use \u001b[1m`wandb login --relogin`\u001b[0m to force relogin\n"},"children":[],"key":"aQixbiTeOQ"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"True","content_type":"text/plain"}}},"children":[],"key":"rBpz2e8tEr"}],"key":"VUWv9R3rBR"}],"key":"ZHgaDIUrzN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nos.environ[\"WANDB_PROJECT\"]=\"sentiment_analysis\"","key":"JN1cLHh0fr"},{"type":"outputs","id":"LuDHTCHLWvW_hGbx_fTYU","children":[],"key":"HL83pUoNul"}],"key":"DvX9Vi84i3"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"サンプルデータの確認","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qCVXke216B"}],"identifier":"id","label":"サンプルデータの確認","html_id":"id-3","implicit":true,"enumerator":"2.1.3","key":"CDTvzw8alg"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"取得したデータセットの中身を確認します。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uAY2s2oDG9"}],"key":"gbC6WNcLdN"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"データセットはこのようにtrain, validation, testに分かれています。\n[‘text’, ‘source’, ‘label’]といった情報を持っています。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ZmRK3PIN55"}],"key":"dHwji5rYWs"}],"key":"bkSPXxOqc3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dataset","key":"wZN4vizM4P"},{"type":"outputs","id":"VP0X24PNV_23gp5BJqu20","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":6,"metadata":{},"data":{"text/plain":{"content":"DatasetDict({\n    train: Dataset({\n        features: ['text', 'source', 'label'],\n        num_rows: 1839\n    })\n    validation: Dataset({\n        features: ['text', 'source', 'label'],\n        num_rows: 324\n    })\n    test: Dataset({\n        features: ['text', 'source', 'label'],\n        num_rows: 870\n    })\n})","content_type":"text/plain"}}},"children":[],"key":"rM3fAibWFN"}],"key":"ORv8JPW2tH"}],"key":"k2oCGMLQH7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dataset.set_format(type=\"pandas\")\ntrain_df = dataset[\"train\"][:]\ntrain_df.head(5)","key":"lwgDox5XLt"},{"type":"outputs","id":"YJ8xv74dqljDou86gToW1","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"application/vnd.microsoft.datawrangler.viewer.v0+json":{"content":"{\"columns\":[{\"name\":\"index\",\"rawType\":\"int64\",\"type\":\"integer\"},{\"name\":\"text\",\"rawType\":\"object\",\"type\":\"string\"},{\"name\":\"source\",\"rawType\":\"object\",\"type\":\"string\"},{\"name\":\"label\",\"rawType\":\"int64\",\"type\":\"integer\"}],\"ref\":\"7ff8d620-6a93-4c90-8b6a-b6cd671c7b9f\",\"rows\":[[\"0\",\"okay i\\\\u2019m sorry but TAYLOR SWIFT LOOKS NOTHING LIKE JACKIE O SO STOP COMPARING THE TWO. c\\\\u2019mon America aren\\\\u2019t you sick of her yet? (sorry) \",\"sem_eval_2017\",\"2\"],[\"1\",\"@user the DC comics site has Batman 44 releases on the 9th but its out now? \",\"sem_eval_2017\",\"1\"],[\"2\",\"\\\"Frank Gaffrey\\\\u002c Cliff May\\\\u002c Steve Emerson: Brilliant. \\\\\\\"\\\"\\\"\\\"Looming Threats: Iran\\\\u002c Hezbollah Hamas\\\\\\\"\\\"\\\"\\\" is the best #cufidc session I\\\\u2019ve had thus far.\\\" \",\"sem_eval_2017\",\"0\"],[\"3\",\"The tragedy of only thinking up hilarious tweets for the Summer Olympics now is that in four years there may be no place for them. \",\"sem_eval_2017\",\"2\"],[\"4\",\"\\\"Oliseh meets with Victor Moses in London: Super Eagles coach, Sunday Oliseh, has met with Nigeria and Chelsea ... \",\"sem_eval_2017\",\"1\"]],\"shape\":{\"columns\":3,\"rows\":5}}","content_type":"application/vnd.microsoft.datawrangler.viewer.v0+json"},"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>text</th>\n      <th>source</th>\n      <th>label</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>okay i\\u2019m sorry but TAYLOR SWIFT LOOKS NOT...</td>\n      <td>sem_eval_2017</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>@user the DC comics site has Batman 44 release...</td>\n      <td>sem_eval_2017</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>\"Frank Gaffrey\\u002c Cliff May\\u002c Steve Eme...</td>\n      <td>sem_eval_2017</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>The tragedy of only thinking up hilarious twee...</td>\n      <td>sem_eval_2017</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>\"Oliseh meets with Victor Moses in London: Sup...</td>\n      <td>sem_eval_2017</td>\n      <td>1</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"                                                text         source  label\n0  okay i\\u2019m sorry but TAYLOR SWIFT LOOKS NOT...  sem_eval_2017      2\n1  @user the DC comics site has Batman 44 release...  sem_eval_2017      1\n2  \"Frank Gaffrey\\u002c Cliff May\\u002c Steve Eme...  sem_eval_2017      0\n3  The tragedy of only thinking up hilarious twee...  sem_eval_2017      2\n4  \"Oliseh meets with Victor Moses in London: Sup...  sem_eval_2017      1","content_type":"text/plain"}}},"children":[],"key":"m1Qk5MeDVF"}],"key":"VzsVRUMY8A"}],"key":"eSIDCnv2jO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dataset[\"train\"].features","key":"gT7JqQhn2C"},{"type":"outputs","id":"L4RnKB-W1DQYF6Hz_Owi6","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":8,"metadata":{},"data":{"text/plain":{"content":"{'text': Value(dtype='string', id=None),\n 'source': Value(dtype='string', id=None),\n 'label': ClassLabel(names=['positive', 'neutral', 'negative'], id=None)}","content_type":"text/plain"}}},"children":[],"key":"F0aStXBWbs"}],"key":"UTJSPZRo8L"}],"key":"KDe9nVcsOf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import matplotlib.pyplot as plt\ntrain_df[\"label\"].value_counts(ascending=True).plot(kind=\"barh\", title=\"Train Dataset\")","key":"iQIjQovuqd"},{"type":"outputs","id":"3TZjChltuRPG1nCj4u7Lk","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":9,"metadata":{},"data":{"text/plain":{"content":"<Axes: title={'center': 'Train Dataset'}>","content_type":"text/plain"}}},"children":[],"key":"brQWc9iCbS"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"03bde67fdeaf84b43310b7c9ae7b8743","path":"/build/03bde67fdeaf84b43310b7c9ae7b8743.png"},"text/plain":{"content":"<Figure size 640x480 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"IIzotWeaWN"}],"key":"ADY9DR7f6O"}],"key":"gjBJIaaNV1"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"テキストの確認","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cdXGg4EfNW"}],"identifier":"id","label":"テキストの確認","html_id":"id-4","implicit":true,"enumerator":"2.1.4","key":"kRlbSQqtSW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Transformerモデルは、最大コンテキストサイズ(maximum context size)と呼ばれる最大入力系列長があります。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"RYrpeCdQs0"}],"key":"FxldK2J9Y7"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"モデルのコンテキストサイズより長いテキストは切り捨てる必要があり、切り捨てたテキストに重要な情報が含まれている場合、性能の低下につながることがあります。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hAmRtK0h36"}],"key":"VHyk8SyG1p"}],"key":"YDpvqHhh95"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"train_df[\"text_length\"]=train_df[\"text\"].str.len()","key":"TtzkM1PvjD"},{"type":"outputs","id":"wlC2al9wjV9rQU68C7dRU","children":[],"key":"aUeGWsjPF5"}],"key":"skjmO4Iwww"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"train_df.boxplot(column=\"text_length\", by=\"label\", figsize=(12, 6))\n","key":"K8yhBmGXzo"},{"type":"outputs","id":"0mYvUzzh8ZFN0sCh-w2xn","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":11,"metadata":{},"data":{"text/plain":{"content":"<Axes: title={'center': 'text_length'}, xlabel='label'>","content_type":"text/plain"}}},"children":[],"key":"Au3sznd5qq"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"c3e2ec270cbf9d31c31f43ac0a47678d","path":"/build/c3e2ec270cbf9d31c31f43ac0a47678d.png"},"text/plain":{"content":"<Figure size 1200x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"zEadipWrSI"}],"key":"tMQrjFyZka"}],"key":"dgMKq5dHLN"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"トークン化","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q3vk3bfaju"}],"identifier":"id","label":"トークン化","html_id":"id-5","implicit":true,"enumerator":"2.2","key":"DItbU0wMrr"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"コンピュータは、入力として生の文字列を受け取ることができません。その代わりに、テキストがトークン化され、数値ベクトルとしてエンコードされていることが想定しています。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tkxkPidKQf"}],"key":"xae1bxSQif"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"トークン化は、文字列をモデルで使用される最小単位に分解するステップです。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rGljRfTyjd"}],"key":"u2fUiWZDzM"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Transformerライブラリー は便利なAutoTokenizerクラスを提供しており、事前学習済みモデルに関連つけられたトークナイザーを素早く使用することができます。","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EQS6lnsHnL"}],"key":"ksutZwJq2f"}],"key":"nCokd2M3EN"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"トークナイザの動作確認","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"id7ecj8iC7"}],"identifier":"id","label":"トークナイザの動作確認","html_id":"id-6","implicit":true,"enumerator":"2.2.1","key":"ChMRbOUXtd"}],"key":"zW5ab6CjfZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"tokenizerテキストを数値形式（トークン）に変換します。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JDtQzSabDJ"}],"key":"bMjAzPLIly"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"入力テキストをトークンに分割します","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"JXBe3f5qjq"}],"key":"tBfsU8vIxb"}],"key":"VTHqPLIxtz"},{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"特殊トークンが自動的に付加されます","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eItVA8xJoN"}],"key":"hgOhSPI5JR"}],"key":"o9zxSi2ewJ"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"トークンをトークンIDに変換します","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"s8bJ6iaVnk"}],"key":"brdu4xMG3Z"}],"key":"Sg4ncfznw3"}],"key":"ERctigpQXg"}],"key":"kp4DhrpTuf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from transformers import AutoTokenizer\nmodel_ckpt = \"distilbert-base-uncased\"\ntokenizer = AutoTokenizer.from_pretrained(model_ckpt)","key":"K7KpoiTFho"},{"type":"outputs","id":"NC8aA6V7FNOqVPVQju_cN","children":[],"key":"SGbu4jl56n"}],"key":"I2ZJtTSW29"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"train_df[\"text\"][0]","key":"KdbnJ2444C"},{"type":"outputs","id":"z4L6vBeWXVA0gMlNn-lj_","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":13,"metadata":{},"data":{"text/plain":{"content":"'okay i\\\\u2019m sorry but TAYLOR SWIFT LOOKS NOTHING LIKE JACKIE O SO STOP COMPARING THE TWO. c\\\\u2019mon America aren\\\\u2019t you sick of her yet? (sorry) '","content_type":"text/plain"}}},"children":[],"key":"DIuRXhn2QR"}],"key":"V7EEcSeRgY"}],"key":"mM9cWOHcuU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sample_text_encoded = tokenizer(train_df[\"text\"][0])\nsample_text_encoded","key":"Ol2UL12Tpi"},{"type":"outputs","id":"XumPn6VPP082kQd0Xj9An","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":14,"metadata":{},"data":{"text/plain":{"content":"{'input_ids': [101, 3100, 1045, 1032, 23343, 24096, 2683, 2213, 3374, 2021, 4202, 9170, 3504, 2498, 2066, 9901, 1051, 2061, 2644, 13599, 1996, 2048, 1012, 1039, 1032, 23343, 24096, 2683, 8202, 2637, 4995, 1032, 23343, 24096, 2683, 2102, 2017, 5305, 1997, 2014, 2664, 1029, 1006, 3374, 1007, 102], 'attention_mask': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]}","content_type":"text/plain"}}},"children":[],"key":"uAoqnxoOwS"}],"key":"n7oXostZdp"}],"key":"K02Dscbmcp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"結果にinput_idsとattention_maskが含まれます。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"znOzUcyhIc"}],"key":"lFhYMH05GZ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"input_ids: 数字にエンコードされたトークン","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sC9lxNrWfq"}],"key":"mzyVXFmHqy"}],"key":"kfu9SMgSxO"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"attention_mask: モデルで有効なトークンかどうかを判別するためのマスクです。無効なトークン（例えば、PADなど）に対しては、attention_maskを\nとして処理します。","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"VU2YuKOZV7"}],"key":"h0WNguf724"}],"key":"iU4lANAzAM"}],"key":"kFExDNaVkk"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"各batchにおいて、入力系列はbatch内最大系列長までpaddingされます。","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"zbzMMEDwwL"}],"key":"ZwI3AB2Taw"},{"type":"image","url":"/build/attention_id-3873cba03fa81523923bc1d9baa87924.png","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"RPSwkOG7Dr","urlSource":"./Figure/attention_id.png"}],"key":"ZHdAYL98XO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"トークナイザの結果は数字にエンコードされているため、トークン文字列を得るには、convert_ids_to_tokensを用います。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cEVgZS0qLL"}],"key":"VDVoMgvO67"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"文の開始が[CLS]、文の終了が[SEP]という特殊なトークンとなっています。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OUsSCoPwig"}],"key":"h8xACzP2nY"}],"key":"WVM6BMKzmu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tokens = tokenizer.convert_ids_to_tokens(sample_text_encoded.input_ids)\nprint(tokens)","key":"uHS2wrDBZx"},{"type":"outputs","id":"PhE8ibe-STWIVr9vpCDHg","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"['[CLS]', 'okay', 'i', '\\\\', 'u2', '##01', '##9', '##m', 'sorry', 'but', 'taylor', 'swift', 'looks', 'nothing', 'like', 'jackie', 'o', 'so', 'stop', 'comparing', 'the', 'two', '.', 'c', '\\\\', 'u2', '##01', '##9', '##mon', 'america', 'aren', '\\\\', 'u2', '##01', '##9', '##t', 'you', 'sick', 'of', 'her', 'yet', '?', '(', 'sorry', ')', '[SEP]']\n"},"children":[],"key":"yiMuc4B9M1"}],"key":"PfJQ6ZwnFg"}],"key":"zCZZjanDfN"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"データセット全体のトークン化","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OLiQ8KxNy4"}],"identifier":"id","label":"データセット全体のトークン化","html_id":"id-7","implicit":true,"enumerator":"2.2.2","key":"yovLGVQbxs"}],"key":"gIaOcrPTtD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def tokenize(batch):\n    return tokenizer(batch[\"text\"], padding=True, truncation=True)","key":"bgnWdIhRCm"},{"type":"outputs","id":"-NYpNmRq1rwdhn8ge2B5l","children":[],"key":"RHp3b3hxpu"}],"key":"BvmeJ3wWRQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dataset.reset_format()","key":"JivLnHnIbv"},{"type":"outputs","id":"PONeHxWj9bfosojRGQIeF","children":[],"key":"LQOyBAneQd"}],"key":"IoRtOylyg3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dataset_encoded = dataset.map(tokenize, batched=True, batch_size=None)","key":"GhGFPbFOh9"},{"type":"outputs","id":"prIwCd4MrTQP-zB_wUSNv","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"9b6dd632bdb64a529c1c62c8a368ab9b\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Map:   0%|          | 0/324 [00:00<?, ? examples/s]","content_type":"text/plain"}}},"children":[],"key":"U3xdFos7xs"}],"key":"bXh8WvtmZP"}],"key":"I2XS3x0DMZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nsample_encoded = dataset_encoded[\"train\"][0]\npd.DataFrame(\n    [sample_encoded[\"input_ids\"]\n     , sample_encoded[\"attention_mask\"]\n     , tokenizer.convert_ids_to_tokens(sample_encoded[\"input_ids\"])],\n    ['input_ids', 'attention_mask', \"tokens\"]\n).T","key":"Vq1Lgb4w1c"},{"type":"outputs","id":"3vJiWPWHVfEsjJC6iqK0E","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":19,"metadata":{},"data":{"application/vnd.microsoft.datawrangler.viewer.v0+json":{"content":"{\"columns\":[{\"name\":\"index\",\"rawType\":\"int64\",\"type\":\"integer\"},{\"name\":\"input_ids\",\"rawType\":\"object\",\"type\":\"string\"},{\"name\":\"attention_mask\",\"rawType\":\"object\",\"type\":\"string\"},{\"name\":\"tokens\",\"rawType\":\"object\",\"type\":\"string\"}],\"ref\":\"82c21289-e1a7-4422-82fb-f0feb6413095\",\"rows\":[[\"0\",\"101\",\"1\",\"[CLS]\"],[\"1\",\"3100\",\"1\",\"okay\"],[\"2\",\"1045\",\"1\",\"i\"],[\"3\",\"1032\",\"1\",\"\\\\\"],[\"4\",\"23343\",\"1\",\"u2\"],[\"5\",\"24096\",\"1\",\"##01\"],[\"6\",\"2683\",\"1\",\"##9\"],[\"7\",\"2213\",\"1\",\"##m\"],[\"8\",\"3374\",\"1\",\"sorry\"],[\"9\",\"2021\",\"1\",\"but\"],[\"10\",\"4202\",\"1\",\"taylor\"],[\"11\",\"9170\",\"1\",\"swift\"],[\"12\",\"3504\",\"1\",\"looks\"],[\"13\",\"2498\",\"1\",\"nothing\"],[\"14\",\"2066\",\"1\",\"like\"],[\"15\",\"9901\",\"1\",\"jackie\"],[\"16\",\"1051\",\"1\",\"o\"],[\"17\",\"2061\",\"1\",\"so\"],[\"18\",\"2644\",\"1\",\"stop\"],[\"19\",\"13599\",\"1\",\"comparing\"],[\"20\",\"1996\",\"1\",\"the\"],[\"21\",\"2048\",\"1\",\"two\"],[\"22\",\"1012\",\"1\",\".\"],[\"23\",\"1039\",\"1\",\"c\"],[\"24\",\"1032\",\"1\",\"\\\\\"],[\"25\",\"23343\",\"1\",\"u2\"],[\"26\",\"24096\",\"1\",\"##01\"],[\"27\",\"2683\",\"1\",\"##9\"],[\"28\",\"8202\",\"1\",\"##mon\"],[\"29\",\"2637\",\"1\",\"america\"],[\"30\",\"4995\",\"1\",\"aren\"],[\"31\",\"1032\",\"1\",\"\\\\\"],[\"32\",\"23343\",\"1\",\"u2\"],[\"33\",\"24096\",\"1\",\"##01\"],[\"34\",\"2683\",\"1\",\"##9\"],[\"35\",\"2102\",\"1\",\"##t\"],[\"36\",\"2017\",\"1\",\"you\"],[\"37\",\"5305\",\"1\",\"sick\"],[\"38\",\"1997\",\"1\",\"of\"],[\"39\",\"2014\",\"1\",\"her\"],[\"40\",\"2664\",\"1\",\"yet\"],[\"41\",\"1029\",\"1\",\"?\"],[\"42\",\"1006\",\"1\",\"(\"],[\"43\",\"3374\",\"1\",\"sorry\"],[\"44\",\"1007\",\"1\",\")\"],[\"45\",\"102\",\"1\",\"[SEP]\"],[\"46\",\"0\",\"0\",\"[PAD]\"],[\"47\",\"0\",\"0\",\"[PAD]\"],[\"48\",\"0\",\"0\",\"[PAD]\"],[\"49\",\"0\",\"0\",\"[PAD]\"]],\"shape\":{\"columns\":3,\"rows\":78}}","content_type":"application/vnd.microsoft.datawrangler.viewer.v0+json"},"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>input_ids</th>\n      <th>attention_mask</th>\n      <th>tokens</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>101</td>\n      <td>1</td>\n      <td>[CLS]</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>3100</td>\n      <td>1</td>\n      <td>okay</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1045</td>\n      <td>1</td>\n      <td>i</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>1032</td>\n      <td>1</td>\n      <td>\\</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>23343</td>\n      <td>1</td>\n      <td>u2</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>73</th>\n      <td>0</td>\n      <td>0</td>\n      <td>[PAD]</td>\n    </tr>\n    <tr>\n      <th>74</th>\n      <td>0</td>\n      <td>0</td>\n      <td>[PAD]</td>\n    </tr>\n    <tr>\n      <th>75</th>\n      <td>0</td>\n      <td>0</td>\n      <td>[PAD]</td>\n    </tr>\n    <tr>\n      <th>76</th>\n      <td>0</td>\n      <td>0</td>\n      <td>[PAD]</td>\n    </tr>\n    <tr>\n      <th>77</th>\n      <td>0</td>\n      <td>0</td>\n      <td>[PAD]</td>\n    </tr>\n  </tbody>\n</table>\n<p>78 rows × 3 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"   input_ids attention_mask tokens\n0        101              1  [CLS]\n1       3100              1   okay\n2       1045              1      i\n3       1032              1      \\\n4      23343              1     u2\n..       ...            ...    ...\n73         0              0  [PAD]\n74         0              0  [PAD]\n75         0              0  [PAD]\n76         0              0  [PAD]\n77         0              0  [PAD]\n\n[78 rows x 3 columns]","content_type":"text/plain"}}},"children":[],"key":"xMEV09nLx7"}],"key":"u4DvmFyDys"}],"key":"XjSpSBeIDU"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"分類器の実装","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RYEfjhHR4P"}],"identifier":"id","label":"分類器の実装","html_id":"id-8","implicit":true,"enumerator":"2.3","key":"a3y3qAgrfA"},{"type":"heading","depth":4,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"事前学習モデルの導入","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"uuTmUNPLuD"}],"identifier":"id","label":"事前学習モデルの導入","html_id":"id-9","implicit":true,"enumerator":"2.3.1","key":"RTJx9Pj35K"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Transformerライブラリは事前学習モデルの使用ため","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"XEOQiO9SxH"},{"type":"inlineCode","value":"AutoModel","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"lUT0lz6fDl"},{"type":"text","value":"クラスを提供します。","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vKW1j9uTp0"}],"key":"y1y1N0JP4z"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"inlineCode","value":"AutoModel","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"tpFtE62uzG"},{"type":"text","value":"クラスはトークンエンコーディングを埋め込みに変換し、エンコーダスタックを経由して","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"PqcPcLsPfy"},{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"最後の","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"PQo68ZEyGD"}],"key":"kHutPvVFXO"},{"type":"text","value":"隠れ状態を返します。","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"HDVJwMUCNG"}],"key":"HBRj9AQNar"}],"key":"FUKAVDSAca"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import torch\nfrom transformers import AutoModel\n\n# GPUある場合はGPUを使う\ndevice = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\nmodel = AutoModel.from_pretrained(model_ckpt).to(device)","key":"RmwMpCZqW2"},{"type":"outputs","id":"HJC_Tx3hDNJjVUPtlyH4p","children":[],"key":"xIsrtYz2tD"}],"key":"lU69Y52zCH"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"最初に、文字列をエンコーダしてトークンをPyTorchのテンソルに変換する必要があります。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kqKkg1PnAl"}],"key":"p8wxXBFUKO"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"結果として得られるテンソルは","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"y7y3rV9sYu"},{"type":"inlineCode","value":"[batch_size,n_tokens]","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GkEp6rwKw4"},{"type":"text","value":"という形状です。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ALGfR8cMFm"}],"key":"scIbaFMGjR"}],"key":"jY67jKkCLv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"text = \"this is a test\"\ninputs = tokenizer(text, return_tensors=\"pt\")\nprint(f\"Input tensor shape: {inputs['input_ids'].size()}\")","key":"lHfHIMPA1Z"},{"type":"outputs","id":"iP8mycISaaYvwsrICElNK","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Input tensor shape: torch.Size([1, 6])\n"},"children":[],"key":"nsWf2lR3jq"}],"key":"hDd0m9FxvA"}],"key":"EAiPA0Xuty"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"得られるテンソルをモデルの入力として渡します。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YnUP5jj2g1"}],"key":"ZuiNtWDL3p"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"モデルと同じデバイス(GPU or CPU)に設置します。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PQT0tztBg9"}],"key":"iNgrp0TJ9v"}],"key":"PefEN6zkHf"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"計算のメモリを減らせるため、","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"H78CZXmBS2"},{"type":"inlineCode","value":"torch.no_grad()","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"YTTBvMPmxY"},{"type":"text","value":"で、勾配の自動計算を無効します。","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"uMlXxJX6pP"}],"key":"Ft8xvEAtD8"}],"key":"DK2t2TTQKX"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"出力には隠れ状態、損失、アテンションのオブジェクトが含まれます。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"vMmWYcmSXE"}],"key":"ch2vlrBTMY"}],"key":"gwaWSQ4579"}],"key":"MmpCLaCHek"}],"key":"Z7STevjfAi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"inputs = {k:v.to(device) for k,v in inputs.items()}\nwith torch.no_grad():\n    outputs = model(**inputs)\nprint(outputs)","key":"lYixIxpGK8"},{"type":"outputs","id":"CoU0SNjjyC8D-n40dcMRi","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"BaseModelOutput(last_hidden_state=tensor([[[-0.1565, -0.1862,  0.0528,  ..., -0.1188,  0.0662,  0.5470],\n         [-0.3575, -0.6484, -0.0618,  ..., -0.3040,  0.3508,  0.5221],\n         [-0.2772, -0.4459,  0.1818,  ..., -0.0948, -0.0076,  0.9958],\n         [-0.2841, -0.3917,  0.3753,  ..., -0.2151, -0.1173,  1.0526],\n         [ 0.2661, -0.5094, -0.3180,  ..., -0.4203,  0.0144, -0.2149],\n         [ 0.9441,  0.0112, -0.4714,  ...,  0.1439, -0.7288, -0.1619]]],\n       device='cuda:0'), hidden_states=None, attentions=None)\n"},"children":[],"key":"qig0C6c6HN"}],"key":"ZKVZwmGkp7"}],"key":"X5I6A9WFxd"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"隠れた状態テンソルを見ると、その形状は [batch_size, n_tokens, hidden_dim] であることがわかります。つまり、6つの入力トークンのそれぞれに対して、768次元のベクトルが返されます。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K73owN9kuL"}],"key":"ddDiHzWAG2"}],"key":"XoOhwDUx7p"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"outputs.last_hidden_state.size()","key":"vAc8BpIbm1"},{"type":"outputs","id":"gNJBAMhQMZ4H6uXyZ8iSQ","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":23,"metadata":{},"data":{"text/plain":{"content":"torch.Size([1, 6, 768])","content_type":"text/plain"}}},"children":[],"key":"Wj1RtYkRJv"}],"key":"IRvpRocGt0"}],"key":"JrgCL0E6uQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"分類タスクでは、","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DF6tKoHdL7"},{"type":"inlineCode","value":"[CLS]","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fHbCq8XbZ1"},{"type":"text","value":" トークンに関連する隠れた状態を入力特徴として使用するのが一般的な方法です。このトークンは各シーケンスの始まりに現れるため、次のように outputs.last_hidden_state に単純にインデックスを付けることで抽出できます。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JoXHtSoKWn"}],"key":"gJ5nDZYR5J"}],"key":"GT3VwUALK9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"outputs.last_hidden_state[:,0].size()\n","key":"USXQlNWvyn"},{"type":"outputs","id":"82Lo7T-e4mLDsC_miXWxA","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":24,"metadata":{},"data":{"text/plain":{"content":"torch.Size([1, 768])","content_type":"text/plain"}}},"children":[],"key":"qTv2s588zl"}],"key":"b17gJatCI8"}],"key":"o4yLFUUtn6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"最後の隠れ状態を取得する方法がわかりましたので、データ全体に対して処理を行うため、これまでのステップを関数でまとめます。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Srf66TJiGK"}],"key":"KptSY1WuA1"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"そして、データ全体に適用し、すべてのテキストの隠れ状態を抽出します。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"K1Zsh4CEMr"}],"key":"eUkxz3o96D"}],"key":"m43V0QkvQ2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def extract_hidden_states(batch):\n    # Place model inputs on the GPU\n    inputs = {k:v.to(device) for k,v in batch.items() \n              if k in tokenizer.model_input_names}\n    # Extract last hidden states\n    with torch.no_grad():\n        last_hidden_state = model(**inputs).last_hidden_state\n    # Return vector for [CLS] token\n    return {\"hidden_state\": last_hidden_state[:,0].cpu().numpy()}","key":"oLEPsUkopy"},{"type":"outputs","id":"ahXaV1G-4EnyOM1DqPqu-","children":[],"key":"waJUN2XAZq"}],"key":"ul9UZvuo6D"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dataset_encoded.set_format(type=\"torch\", columns=[\"input_ids\", \"attention_mask\",\"label\"])\n","key":"D3vE8GEDIS"},{"type":"outputs","id":"Jde0SlS5kL6Dj_3dml8yi","children":[],"key":"i9O4zlmh4N"}],"key":"wDWvymOvVu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dataset_hidden=dataset_encoded.map(extract_hidden_states, batched=True, batch_size=16)","key":"nv3MnlIYk4"},{"type":"outputs","id":"KoJtYlEFKiyu3iXHQVGyQ","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"de282f712cf542339a7cee8ace81cafa\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Map:   0%|          | 0/324 [00:00<?, ? examples/s]","content_type":"text/plain"}}},"children":[],"key":"zh01K2pCNK"}],"key":"M8qH1wgMjH"}],"key":"wDre3VJjdO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"AutoModelForSequenceClassificationのファインチューニング","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"moq8fsregx"}],"identifier":"automodelforsequenceclassification","label":"AutoModelForSequenceClassificationのファインチューニング","html_id":"automodelforsequenceclassification","implicit":true,"enumerator":"2.3.2","key":"rQhHDnMTJo"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"transformerライブラリは、ファインチューニングのタスクに応じてAPIを提供しています。","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"VQ6yTcq5u3"}],"key":"wEorJLhOpa"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"分類タスクの場合、","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"veaA1u4Mk0"},{"type":"inlineCode","value":"AutoModel","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ut6swZS8Ev"},{"type":"text","value":"の代わりに","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"OhjVzYJeHE"},{"type":"inlineCode","value":"AutoModelForSequenceClassification","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"JmM91YL8An"},{"type":"text","value":"を使用します。","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"r9p3oKvlCg"}],"key":"iYThskSBub"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"inlineCode","value":"AutoModelForSequenceClassification","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"B03hpj09Iu"},{"type":"text","value":"が事前学習済みモデルの出力の上に分類器ヘッドを持っており、モデルの設定がより簡単になります。","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"secOpWZ9P3"}],"key":"Ezk0BJ8a1W"}],"key":"EGrIT43Aym"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from transformers import AutoModelForSequenceClassification\n\ndevice = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\nnum_labels = 3\n\nmodel = (AutoModelForSequenceClassification\n    .from_pretrained(model_ckpt, num_labels=num_labels)\n    .to(device))","key":"acD31WGhPX"},{"type":"outputs","id":"zhJJTKpgTLUeAiwd2czcK","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: ['classifier.bias', 'classifier.weight', 'pre_classifier.bias', 'pre_classifier.weight']\nYou should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.\n"},"children":[],"key":"yVELHMgYtZ"}],"key":"dFUuVzjNnM"}],"key":"uiJa8r1J8r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model","key":"xqA6jqNt12"},{"type":"outputs","id":"jzSGt59q0SmU9tKLoe6mQ","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":29,"metadata":{},"data":{"text/plain":{"content":"DistilBertForSequenceClassification(\n  (distilbert): DistilBertModel(\n    (embeddings): Embeddings(\n      (word_embeddings): Embedding(30522, 768, padding_idx=0)\n      (position_embeddings): Embedding(512, 768)\n      (LayerNorm): LayerNorm((768,), eps=1e-12, elementwise_affine=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n    )\n    (transformer): Transformer(\n      (layer): ModuleList(\n        (0-5): 6 x TransformerBlock(\n          (attention): DistilBertSdpaAttention(\n            (dropout): Dropout(p=0.1, inplace=False)\n            (q_lin): Linear(in_features=768, out_features=768, bias=True)\n            (k_lin): Linear(in_features=768, out_features=768, bias=True)\n            (v_lin): Linear(in_features=768, out_features=768, bias=True)\n            (out_lin): Linear(in_features=768, out_features=768, bias=True)\n          )\n          (sa_layer_norm): LayerNorm((768,), eps=1e-12, elementwise_affine=True)\n          (ffn): FFN(\n            (dropout): Dropout(p=0.1, inplace=False)\n            (lin1): Linear(in_features=768, out_features=3072, bias=True)\n            (lin2): Linear(in_features=3072, out_features=768, bias=True)\n            (activation): GELUActivation()\n          )\n          (output_layer_norm): LayerNorm((768,), eps=1e-12, elementwise_affine=True)\n        )\n      )\n    )\n  )\n  (pre_classifier): Linear(in_features=768, out_features=768, bias=True)\n  (classifier): Linear(in_features=768, out_features=3, bias=True)\n  (dropout): Dropout(p=0.2, inplace=False)\n)","content_type":"text/plain"}}},"children":[],"key":"O2nkKgiGWF"}],"key":"yza8hujJDO"}],"key":"wJtPBHZSz4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"inputs = tokenizer(\"I purchased these boots to use both for everyday wear and when riding my motorcycle.\", return_tensors=\"pt\") # pytorch tensorに変換するためにreturn_tensors=\"pt\"を指定\ninputs = {k: v.to(device) for k, v in inputs.items()}\nwith torch.no_grad():\n    outputs = model(**inputs)\nprint(outputs)","key":"cw7KEHpOId"},{"type":"outputs","id":"mYxCVEeBIz9gcWEj8sG25","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"SequenceClassifierOutput(loss=None, logits=tensor([[ 0.0746, -0.1015, -0.0341]], device='cuda:0'), hidden_states=None, attentions=None)\n"},"children":[],"key":"IyutBpkAAJ"}],"key":"YhdkxtIqza"}],"key":"I9cyx1w81t"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"学習の準備","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zbI20AVbFx"}],"identifier":"id","label":"学習の準備","html_id":"id-10","implicit":true,"enumerator":"2.3.3","key":"Z6VQCgdnAn"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"学習時に性能指標を与える必要があるため、それを関数化して定義しておきます。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"maMr6mEbIx"}],"key":"keerBsKTX2"}],"key":"FUIoUA4A5R"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from sklearn.metrics import accuracy_score, f1_score\n\ndef compute_metrics(pred):\n    labels = pred.label_ids\n    preds = pred.predictions.argmax(-1)\n    f1 = f1_score(labels, preds, average=\"weighted\")\n    acc = accuracy_score(labels, preds)\n    return {\"accuracy\": acc, \"f1\": f1}","key":"nB0hbXwMYu"},{"type":"outputs","id":"6h-ny-5R_EakRQKCRLqO2","children":[],"key":"UTsiTaPDzf"}],"key":"GBiTrZrs95"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"学習を効率化するために、transformerライブラリの","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WScJb2OxWm"},{"type":"inlineCode","value":"Trainer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cP77jJJ8Z9"},{"type":"text","value":" APIを使用します。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X8ibYZVboT"}],"key":"XxRRkCobRB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"Trainer","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pPCAgvfcHO"},{"type":"text","value":"クラスを初期化する際には、","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gjKYkafDww"},{"type":"inlineCode","value":"TrainingArguments","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zfxIHr26qR"},{"type":"text","value":"という訓練に関する様々な設定値の集合を引数に与えることで、訓練の設定に関する細かい調整が可能です。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GJ2LFC8mGy"}],"key":"QfPV4b4WmK"}],"key":"rtIQHDSr4u"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\nfrom transformers import TrainingArguments\n\nbatch_size = 16\nlogging_steps = len(dataset_encoded[\"train\"]) // batch_size\nmodel_name = \"sample-text-classification-bert\"\n\ntraining_args = TrainingArguments(\n    output_dir=model_name,\n    num_train_epochs=2,\n    learning_rate=2e-5,\n    per_device_train_batch_size=batch_size,\n    per_device_eval_batch_size=batch_size,\n    weight_decay=0.01,\n    eval_strategy=\"epoch\",\n    disable_tqdm=False,\n    logging_steps=logging_steps,\n    push_to_hub=False,\n    log_level=\"error\",\n    report_to=\"wandb\",  # wandbに記録\n    run_name=\"bert-sentiment-analysis_20260107\"  # wandbのrun名\n)","key":"Ainx5CFjgI"},{"type":"outputs","id":"YIZeXp45s23KnFvEAmTeP","children":[],"key":"z6uTiduirR"}],"key":"ImCpr79vS5"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Trainerクラスで実行します。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PD1HwPKQiy"}],"key":"LfaNAs1T6W"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"CUDAエラーのデバッグについて:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"geMrJiAGyw"}],"key":"reGr6LGCDp"}],"key":"JD1JtRLqby"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"CUDA_LAUNCH_BLOCKING=1","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"a9eroVmqly"},{"type":"text","value":": GPU操作を同期実行にし、エラーの正確な発生箇所を特定","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"iGVTEPSHl6"}],"key":"T5fv5wmrWU"}],"key":"eWwpJoTtBf"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"TORCH_USE_CUDA_DSA","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"LItnOZ4f9J"},{"type":"text","value":": デバイス側のアサーションを有効化してより詳細なエラー情報を取得","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yOmVCOkn1d"}],"key":"dfu9DGrRzb"}],"key":"fPi5uO1PXD"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"モデルとデータの整合性を事前に確認することで、ラベル数のミスマッチなどの問題を早期発見","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"RFjQr2QarS"}],"key":"Mdfp5DPIwI"}],"key":"m4b1qxbOjY"}],"key":"ZyAOQ4oaYY"}],"key":"VM3AXRr0BJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from transformers import Trainer\n\ntrainer = Trainer(\n    model=model,\n    args=training_args,\n    compute_metrics=compute_metrics,\n    train_dataset=dataset_encoded[\"train\"],\n    eval_dataset=dataset_encoded[\"validation\"],\n    tokenizer=tokenizer\n)\ntrainer.train()","key":"h0rQHULf8N"},{"type":"outputs","id":"5LP5dmtzQy90ZSxoWT22V","children":[],"key":"QupGuU6M8t"}],"key":"vsCxu9aK84"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"学習済みモデルの使用","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ubHNaxvLTi"}],"identifier":"id","label":"学習済みモデルの使用","html_id":"id-11","implicit":true,"enumerator":"2.4","key":"Y99TncoE9s"},{"type":"heading","depth":4,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"モデル精度の検証","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ulro0Uvuf1"}],"identifier":"id","label":"モデル精度の検証","html_id":"id-12","implicit":true,"enumerator":"2.4.1","key":"R1HnNH09Rl"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"学習済みのモデルを他のデータセットに適用します。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"jVcLTQeHkR"}],"key":"kVvQpwjQr2"}],"key":"Wo11Cn7zVQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"preds_output = trainer.predict(dataset_encoded[\"test\"])","key":"x0PIffiZwy"},{"type":"outputs","id":"3WFhMXIBhBeNC6wNc5A3o","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/html":{"content":"","content_type":"text/html"},"text/plain":{"content":"<IPython.core.display.HTML object>","content_type":"text/plain"}}},"children":[],"key":"sw9ssWOhck"}],"key":"hmByAIWuDg"}],"key":"wyrdmgzBdZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport matplotlib.pyplot as plt\nfrom sklearn.metrics import ConfusionMatrixDisplay, confusion_matrix\n\ny_preds = np.argmax(preds_output.predictions, axis=1)\ny_valid = np.array(dataset_encoded[\"test\"][\"label\"])\nlabels = dataset_encoded[\"train\"].features[\"label\"].names\n\ndef plot_confusion_matrix(y_preds, y_true, labels):\n    cm = confusion_matrix(y_true, y_preds, normalize=\"true\")\n    fig, ax = plt.subplots(figsize=(6, 6))\n    disp = ConfusionMatrixDisplay(confusion_matrix=cm, display_labels=labels)\n    disp.plot(cmap=\"Blues\", values_format=\".2f\", ax=ax, colorbar=False)\n    plt.title(\"Normalized confusion matrix\")\n    plt.show()\n\nplot_confusion_matrix(y_preds, y_valid, labels)","key":"mrOg9y0Q5O"},{"type":"outputs","id":"PQ4y7blJJdBz_RwhNuPcI","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"be2e3ca8465498495422be6a43b43869","path":"/build/be2e3ca8465498495422be6a43b43869.png"},"text/plain":{"content":"<Figure size 600x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"olwmi7f4MM"}],"key":"zI1E8mcXsb"}],"key":"mejvNIp5L9"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"モデル保存","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bsGV3X2f0e"}],"identifier":"id","label":"モデル保存","html_id":"id-13","implicit":true,"enumerator":"2.4.2","key":"Ds8B8pPwS9"}],"key":"tsmsUO6YG6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"id2label = {}\nfor i in range(dataset[\"train\"].features[\"label\"].num_classes):\n    id2label[i] = dataset[\"train\"].features[\"label\"].int2str(i)\n\nlabel2id = {}\nfor i in range(dataset[\"train\"].features[\"label\"].num_classes):\n    label2id[dataset[\"train\"].features[\"label\"].int2str(i)] = i\n\ntrainer.model.config.id2label = id2label\ntrainer.model.config.label2id = label2id","key":"gbE3eTcbiN"},{"type":"outputs","id":"p2i3XoZkMAudJukkym0Q_","children":[],"key":"BPVYgmNlCX"}],"key":"yOlWlfXG2r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"trainer.save_model(f\"./Data/sample-text-classification-bert\")","key":"UpXrDuT8NJ"},{"type":"outputs","id":"DKO8FMwtnhhzW_3rTSfOh","children":[],"key":"DMBGR7v6QN"}],"key":"pwfAqfwyoD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"学習済みモデルの読み込み","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IaZZ7MEhrO"}],"identifier":"id","label":"学習済みモデルの読み込み","html_id":"id-14","implicit":true,"enumerator":"2.4.3","key":"BPec4DLnx7"}],"key":"MCVcwD7Mcw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"new_tokenizer = AutoTokenizer\\\n    .from_pretrained(f\"./Data/sample-text-classification-bert\")\n\nnew_model = (AutoModelForSequenceClassification\n    .from_pretrained(f\"./Data/sample-text-classification-bert\")\n    .to(device))","key":"acTexY1XpU"},{"type":"outputs","id":"mS7tXywdT3fO8XZOCy5DZ","children":[],"key":"Y1BuFAj1ls"}],"key":"zOroYraglJ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"サンプルテキストで推論の結果を確認します。","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uhnULRMNi9"}],"key":"WCYf7wyASB"}],"key":"oHsBMix37Y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def id2label(x):\n    label_dict={0:\"positive\",1:\"neutral\",2:\"negative\"}\n    return label_dict[x]","key":"r2rh8vqZEf"},{"type":"outputs","id":"aKGwz7GiIoIhQwONdTNsc","children":[],"key":"sNpNlbuFms"}],"key":"P0RNL0tgAt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"text1=\"this week is not going as i had hoped\"\ntext2=\"awe i love you too!!!! 1 am here i miss you\"","key":"ND1f7NTjJk"},{"type":"outputs","id":"qFGiCEsdtVbf2XphSmbvN","children":[],"key":"BZTmsQEE9I"}],"key":"vwiCTLGuKB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\ninputs = new_tokenizer(text1, return_tensors=\"pt\")\n\nnew_model.eval()\n\nwith torch.no_grad():\n    outputs = new_model(\n        inputs[\"input_ids\"].to(device), \n        inputs[\"attention_mask\"].to(device),\n    )\noutputs.logits\n\ny_preds = np.argmax(outputs.logits.to('cpu').detach().numpy().copy(), axis=1)\ny_preds = [id2label(x) for x in y_preds]\ny_preds","key":"Jw98YOVpKR"},{"type":"outputs","id":"RpyVJN2P4arh6jOveyiFH","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":66,"metadata":{},"data":{"text/plain":{"content":"['negative']","content_type":"text/plain"}}},"children":[],"key":"h6Fnub9vtT"}],"key":"F5zO7dLv79"}],"key":"qanecNfuEX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"inputs = new_tokenizer(text2, return_tensors=\"pt\")\n\nnew_model.eval()\n\nwith torch.no_grad():\n    outputs = new_model(\n        inputs[\"input_ids\"].to(device), \n        inputs[\"attention_mask\"].to(device),\n    )\noutputs.logits\n\ny_preds = np.argmax(outputs.logits.to('cpu').detach().numpy().copy(), axis=1)\ny_preds = [id2label(x) for x in y_preds]\ny_preds","key":"JSaUX1HeF8"},{"type":"outputs","id":"Zn6Bc4ieTCp1PLxk-OaoM","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":67,"metadata":{},"data":{"text/plain":{"content":"['positive']","content_type":"text/plain"}}},"children":[],"key":"pXd6cVdUVq"}],"key":"SeSJI9vUB0"}],"key":"WpNGY852Rc"}],"key":"LPWN3uUASz"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"BERT","url":"/bert","group":"Transformer"},"next":{"title":"BERTopic","url":"/bert-topic","group":"Transformer"}}},"domain":"http://localhost:3001"}